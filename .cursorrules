# .cursorrules
# Invoxo.eu (Laravel + Blade) — Cursor Rules for Code Consistency & Best Practices
# Goal: maximize shipping speed with minimal code, while keeping the codebase predictable and maintainable.

You are working in a Laravel (PHP) monolith using Blade views (Breeze) for the MVP.
All commands MUST be executed inside Docker container: invoxo-app-1
(e.g. `docker exec -it invoxo-app-1 php artisan migrate`)

Priorities: correctness > simplicity > speed. Avoid architecture churn.

================================================================================
1) GLOBAL PRINCIPLES
================================================================================
- Minimize moving parts. Prefer the smallest diff that solves the problem.
- Avoid new dependencies unless explicitly requested.
- Do not add new migrations unless explicitly requested.
- Do not perform broad refactors unless asked; keep changes localized.
- Plans unlock AUTOMATION, never correctness.
- Always respect multi-tenant boundaries.

When uncertain, choose the simplest implementation that:
- is deterministic
- is testable
- is easy to delete or replace later

================================================================================
2) CODING STANDARDS (PHP / LARAVEL)
================================================================================
- Follow PSR-12 and Laravel conventions.
- Use PHP enums where domain values are finite and explicit.
- Avoid over-abstraction; no interfaces unless there are multiple implementations.
- Controllers orchestrate; services contain business logic.
- Use FormRequest for validation + authorization.
- Never trust client-provided values for system-owned fields:
  - totals, vat_rate, tax_treatment, status, number, public tokens.

File organization:
- app/Services/* → business logic (VAT, totals, numbering)
- app/Http/Controllers/* → orchestration only
- app/Http/Requests/* → validation & authorization
- resources/views/* → Blade UI

================================================================================
3) DATA OWNERSHIP & MULTI-TENANCY (CRITICAL)
================================================================================
- Any model with company_id MUST be scoped to auth()->user()->company_id.
- This applies to:
  - index/list queries
  - show/edit/update/delete
  - issuing invoices
  - route model binding

Enforcement pattern:
- If model is injected via route binding:
  - abort(403) if company_id !== auth user company_id
- In FormRequests:
  - authorize() must enforce company ownership

================================================================================
4) PLANS & PERMISSIONS (MVP)
================================================================================
- config/plans.php is the SINGLE source of truth.
- No plans table.
- Subscriptions store plan as STRING (enum-backed).
- There is ALWAYS a single company.
- Plans never restrict correctness — only automation.

Permissions:
- Permissions exist ONLY for gated automation (e.g. vies_validation, vat_rate_auto).
- Presence of permission key = granted (boolean value is display-only).
- Universal features MUST NOT be modeled as permissions.

Examples:
- VAT correctness → always available
- Manual VAT entry → always available
- VIES validation → gated (Pro)
- Automatic VAT decisioning → gated (Pro)

================================================================================
5) VAT DOMAIN RULES (SERVICES-ONLY MVP)
================================================================================
Company:
- company.default_vat_rate = COUNTRY VAT RATE
- Always enabled
- Always required
- Not gated by plan

Optional:
- vat_override_enabled + vat_override_rate
- User-controlled
- Escape hatch only, never forced by plan

Invoice fields:
- tax_treatment (UPPERCASE string enum)
- vat_rate (decimal percentage)
- vat_rate_is_manual (boolean)

Tax treatments (UPPERCASE, fixed set):
- DOMESTIC
- EU_B2B_RC
- EU_B2C
- NON_EU

VAT rules:
- DOMESTIC:
  - client country == company country
  - VAT = company.default_vat_rate (or override)
- EU_B2B_RC:
  - client in EU + VAT ID present
  - VAT = 0
  - reverse charge note
- EU_B2C:
  - client in EU + no VAT ID
  - VAT = company.default_vat_rate (or override)
- NON_EU:
  - VAT = 0
  - outside scope note

Automation rules:
- VAT auto logic runs ONLY:
  - if invoice.status = draft
  - AND user has `vat_rate_auto` permission
- If vat_rate_is_manual = true → NEVER auto-update VAT

Issuance:
- Issued invoices are IMMUTABLE
- VAT snapshot must already exist
- No recomputation after issue

================================================================================
6) VIES & VAT ID VALIDATION
================================================================================
- VAT ID format validation uses config/vat.php (regex only).
- VIES is used ONLY for VAT ID validation (not rates).
- If user lacks `vies_validation` permission:
  - Do NOT queue VAT ID for VIES
  - Do NOT show VIES status
  - VAT ID entry + format validation still allowed
- VIES validation is NOT retroactive.

================================================================================
7) INVOICE UX RULES
================================================================================
- Always show:
  - tax_treatment select
  - vat_rate input

Manual VAT warning:
- If invoice is draft AND vat_rate_is_manual = true:
  - Show non-blocking warning:
    "Manual VAT rate applied. Automatic VAT updates are disabled."
  - Include action: "Reset to company VAT rate"

Reset behavior:
- Set vat_rate_is_manual = false
- Re-run VAT logic immediately
- No confirmation dialog
- Not shown on issued invoices

================================================================================
8) INVOICING MECHANICS
================================================================================
Statuses:
- draft → editable
- issued → immutable
- paid → optional later

Issuing:
- Recalculate totals server-side
- Assign invoice number if missing
- Set issue_date if missing
- Idempotent: calling issue twice must not change results

Invoice number:
- {prefix}-{YYYY}-{000001}
- Sequence per company per year

Money:
- Store monetary values as integer minor units
- Never store floats for money
- VAT rate remains percentage float

================================================================================
9) BLADE UI RULES
================================================================================
- Use Breeze components (<x-app-layout>, inputs, buttons).
- Server-rendered forms only.
- No JS unless explicitly requested.
- Keep markup shallow and readable.

================================================================================
10) TESTING
================================================================================
- For VAT, issuing, or automation changes:
  - Add at least one Feature test.
- Ensure:
  - invoice creation works
  - issuing locks invoice
  - VAT rules behave deterministically
- Tests must not rely on plan_id or plans table.

================================================================================
11) TOOLING & COMMANDS
================================================================================
- All Artisan commands MUST be executed inside Docker:
  - docker exec -it invoxo-app-1 php artisan migrate
  - docker exec -it invoxo-app-1 php artisan test
- PHP 8.3+
- Debian-based images only
- No Vite server assumptions

================================================================================
12) DO-NOT LIST
================================================================================
Do NOT:
- add new packages unless asked
- add migrations unless asked
- refactor auth scaffolding
- introduce OSS / goods VAT logic
- introduce plan-based correctness limits
- auto-reset VAT without user action

================================================================================
END
