# .cursorrules
# Invoxo.eu (Laravel + Blade) — Cursor Rules for Code Consistency & Best Practices
# Goal: maximize shipping speed with minimal code, while keeping the codebase predictable and maintainable.

You are working in a Laravel (PHP) monolith using Blade views (Breeze) for the MVP.
Priorities: correctness > simplicity > speed. Avoid architecture churn.

================================================================================
1) GLOBAL PRINCIPLES
================================================================================
- Minimize moving parts. Prefer the smallest diff that solves the problem.
- Avoid new dependencies unless explicitly requested.
- Do not add new migrations unless explicitly requested.
- Do not run "big refactors" unless asked; keep changes localized.
- Always respect multi-tenant boundaries: every query must be scoped to auth()->user()->company_id unless explicitly public/share.

When uncertain, choose the simplest implementation that:
- is deterministic,
- is testable,
- is easy to delete/replace later.

================================================================================
2) CODING STANDARDS (PHP/LARAVEL)
================================================================================
- Follow PSR-12 and Laravel conventions.
- Use strict, explicit types where helpful, but do not over-type or add interfaces for everything.
- Use services for business logic: VAT, totals, invoice numbering, plan limits.
- Controllers should orchestrate and call services; keep them thin.
- Use FormRequest for validation + authorization.
- Never trust client-provided fields for system-owned data:
  - invoice totals, vat_rate, tax_treatment, number, status, public_id/share_token.
- Treat "issue invoice" as an idempotent operation.

File organization:
- app/Services/* for business logic
- app/Http/Controllers/* only orchestration
- app/Http/Requests/* for validation & authorization
- resources/views/* for Blade UI

================================================================================
3) DATA OWNERSHIP & MULTI-TENANCY (CRITICAL)
================================================================================
- Any model with company_id must always be filtered by auth()->user()->company_id in:
  - index/listing queries
  - route model operations (show/edit/update/destroy/issue)
  - relation creation
- Never allow creating/updating records for another company.

Enforcement pattern:
- In controller methods receiving a model via route model binding:
  - if ((int)$model->company_id !== (int)auth()->user()->company_id) abort(403);
- In FormRequests:
  - authorize() should ensure company_id == auth user company_id (where relevant)

================================================================================
4) INVOICING DOMAIN RULES (MVP)
================================================================================
Statuses:
- draft: editable
- issued: immutable (no edit/update; only view/share/pdf)
- paid: optional later

Issuing rules:
- On issue:
  - recalculate totals (server-side)
  - ensure VAT snapshot fields exist on invoice (tax_treatment, vat_rate, reason)
  - assign invoice number if missing
  - set issue_date if missing
  - set status=issued
- Issuing must be idempotent: calling issue twice should not change number/totals unexpectedly.

Invoice number format (default):
- {company.invoice_prefix}-{YYYY}-{000001}
- Sequence is per company per year (based on latest existing invoice number with same prefix/year).

Money:
- Store as integer minor units:
  - subtotal_minor, vat_minor, total_minor
- Quantity is decimal; compute line_total_minor with round-half-up.
- Never store floats for money amounts (except vat_rate percentage).

VAT (services-only MVP):
- DOMESTIC: buyer country == company country → VAT = company.default_vat_rate
- EU_B2B_RC: buyer in EU + client.vat_id present → VAT 0 + reverse charge note
- EU_B2C: buyer in EU + no vat_id → VAT = company.default_vat_rate
- NON_EU: VAT 0 + outside scope note

================================================================================
5) BLADE UI RULES
================================================================================
- Use Breeze <x-app-layout>, <x-input-label>, <x-text-input>, <x-primary-button>, etc.
- Prefer server-rendered forms; no JS unless requested.
- Keep views functional, minimal. No over-styling.
- Use readable markup; avoid deeply nested divs.

Routing names:
- Use standard resource route names (clients.*, invoices.*).
- Add explicit POST routes for actions like issue.

================================================================================
6) TESTING & SAFETY CHECKS
================================================================================
- For changes affecting core behavior (issue, totals, VAT), add at least one Feature test if time allows.
- At minimum, ensure:
  - migration passes
  - registration works
  - creating client works
  - creating invoice works
  - issuing invoice locks it and assigns number
- Do not introduce nondeterministic logic.

================================================================================
7) TOOLING (LOCAL)
================================================================================
- Prefer PHP 8.3+ compatibility (current environment shows PHP 8.3.6).
- Prefer SQLite in dev (current), Postgres in Docker later.
- No Alpine images; Debian-based images when Docker is used.

Code formatting:
- Use Laravel Pint if configured; otherwise keep formatting consistent manually.

================================================================================
8) CURSOR WORKFLOW RULES (HOW TO EDIT)
================================================================================
- Always provide a concise "Plan" before applying changes.
- Make changes in small diffs:
  - one feature per commit-level change set
- Before editing, locate relevant files and reflect existing patterns.
- Do not overwrite files unless requested; apply incremental edits.
- After changes, ensure routes compile and no missing imports.

================================================================================
9) DO-NOT LIST
================================================================================
Do NOT:
- add new packages unless asked
- add new migrations unless asked
- refactor auth scaffolding
- introduce queues/redis/caching complexity
- implement full VAT OSS/e-services logic in MVP
- implement per-country VAT rates beyond the existing TaxRate table unless asked

================================================================================
10) QUICK COMMANDS (REFERENCE)
================================================================================
- php artisan migrate
- php artisan migrate:fresh
- php artisan db:seed
- php artisan route:list
- php artisan tinker

================================================================================
END
